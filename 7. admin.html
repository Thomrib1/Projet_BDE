const express = require('express');
const sqlite3 = require('sqlite3');
const bodyParser = require('body-parser');
const app = express();
const port = 3000;

app.use(bodyParser.json());

const db = new sqlite3.Database('./bde.db', (err) => {
  if (err) console.error(err);
  else db.run('CREATE TABLE IF NOT EXISTS events (id INTEGER PRIMARY KEY, name TEXT, date TEXT, description TEXT)');
});

app.get('/', (req, res) => {
    res.send(`
        <!DOCTYPE html>
        <html lang="fr">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Admin BDE</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f9; }
                header, footer { text-align: center; padding: 20px; background-color: #333; color: white; }
                section { padding: 20px; }
                label, input, textarea { margin-bottom: 10px; }
                input, textarea { padding: 8px; width: 100%; max-width: 500px; }
                button { background-color: #4CAF50; color: white; padding: 10px 15px; border: none; cursor: pointer; }
                button:hover { background-color: #45a049; }
                ul { list-style-type: none; padding: 0; }
                li { padding: 10px; background-color: #fff; margin: 5px 0; border-radius: 5px; }
            </style>
        </head>
        <body>
            <header><h1>Gestion des Événements</h1></header>
            <section>
                <h2>Ajouter un événement</h2>
                <form id="addEventForm">
                    <label for="event_name">Nom :</label>
                    <input type="text" id="event_name" required><br>
                    <label for="event_date">Date :</label>
                    <input type="date" id="event_date" required><br>
                    <label for="event_description">Description :</label><br>
                    <textarea id="event_description" required></textarea><br>
                    <button type="submit">Ajouter</button>
                </form>
                <h2>Événements existants</h2>
                <ul id="eventList"></ul>
            </section>
            <footer><p>&copy; 2025 BDE Ynov Paris Campus</p></footer>
            <script>
                document.getElementById("addEventForm").addEventListener("submit", async function(event) {
                    event.preventDefault();
                    const event_name = document.getElementById("event_name").value;
                    const event_date = document.getElementById("event_date").value;
                    const event_description = document.getElementById("event_description").value;
                    const response = await fetch('/api/addEvent', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ event_name, event_date, event_description })
                    });
                    const data = await response.json();
                    if (data.success) loadEvents();
                });

                async function loadEvents() {
                    const response = await fetch('/api/getEvents');
                    const events = await response.json();
                    const eventList = document.getElementById("eventList");
                    eventList.innerHTML = '';
                    events.forEach(event => {
                        const li = document.createElement('li');
                        li.textContent = `${event.name} - ${event.date}`;
                        eventList.appendChild(li);
                    });
                }
                loadEvents();
            </script>
        </body>
        </html>
    `);
});

app.post('/api/addEvent', (req, res) => {
    const { event_name, event_date, event_description } = req.body;
    db.run('INSERT INTO events (name, date, description) VALUES (?, ?, ?)', [event_name, event_date, event_description], (err) => {
        if (err) res.json({ success: false });
        else res.json({ success: true });
    });
});

app.get('/api/getEvents', (req, res) => {
    db.all('SELECT * FROM events', [], (err, rows) => {
        if (err) res.json({ success: false });
        else res.json(rows);
    });
});

app.listen(port, () => {
    console.log(`Server running on http://localhost:${port}`);
});
